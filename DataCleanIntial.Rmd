---
title: "Capstone Data Clean Initial"
author: "Michael Helton"
date: "11/8/2021"
output: html_document
---

```{r}
# Load packages
library(bayesrules)
library(tidyverse)
library(rstanarm)
library(broom.mixed)
library(tidybayes)
library(forcats)
library(bayesplot)
library(lubridate)
```

```{r read.csv}
pbp <- read.csv('pbp-2021.csv')
```

```{r as.factor}
pbp$GameId <- as.factor(pbp$GameId)
pbp$Quarter <- as.factor(pbp$Quarter)
pbp$Down <- as.factor(pbp$Down)
pbp$OffenseTeam <- as.factor(pbp$OffenseTeam)
pbp$DefenseTeam <- as.factor(pbp$DefenseTeam)
```

```{r mutate}
pbp <- pbp %>%
  mutate(GameDate = ymd(GameDate),
         timeout = ifelse(grepl('TIMEOUT', Description) == TRUE, 1, 0),
         yardstoTD = 100 - YardLine,
         garbage = 0, 
         garbage = ifelse(grepl('END QUARTER', Description), 1, 
                          ifelse(grepl('GAME HAS', Description), 1, 
                                 ifelse(Description == 'TWO-MINUTE WARNING', 1, 
                                        ifelse(Description == 'GAME', 1, garbage)))))
```

```{r select - due to all values same}
pbp <- pbp %>%
  select(-c(X, X.1, X.2, X.3, Challenger, NextScore, TeamWin, IsMeasurement))
```

```{r filter, eval=FALSE}
pbp <- pbp %>%
  # filter(timeout == 0,
  #        garbage == 0)
```

```{r deadball penalties}
pbp %>%
  filter(IsNoPlay == 1) %>%
  group_by(IsPenalty, Yards) %>%
  summarise(n())
```

```{r 2 penalty plays only one accepted}
pbp %>%
  filter(IsPenalty == 1, IsPenaltyAccepted == 0, IsNoPlay == 1) 
```

```{r}
pbp %>%
  summarise(most = max(Yards), least = min(Yards), avg = mean(Yards))
```

```{r something weird with YardLine Variable}
pbp %>%
  mutate(my = ifelse(Yards > yardstoTD, 'more', 'less')) %>%
  filter(my == 'more') %>%
  select(Description, yardstoTD, Yards, YardLine, YardLineDirection, YardLineFixed)
```

There is something weird with the 50 yard line with the YardLine Variable

```{r one game sample, eval=FALSE}
pbp %>%
  filter(GameId == '2021102409', OffenseTeam == 'TB') %>%
  arrange(Quarter) %>%
  select(Quarter, YardLineDirection) %>%
  view()
```

```{r}
pbp %>%
  mutate(g50 = ifelse(YardLine > 50, 1, 0)) %>%
  group_by(YardLineDirection, g50) %>%
  summarise(n())
```

```{r}
pbp %>%
  group_by(IsTouchdown) %>%
  summarise(n())
```

```{r}
pbp %>%
  group_by() %>%
  summarise(n())
```

```{r}
names(pbp)
```

YardlineFixed switches at half, so field is always left to right not dependent on who's endzone is who's.

```{r}
pbp %>%
  filter(OffenseTeam == '') %>%
  group_by(Description) %>%
  summarise(n())
```

TWO-MINUTE WARNING
END GAME		
END QUARTER 1				
END QUARTER 2				
END QUARTER 3				
END QUARTER 4				
GAME			
THE GAME HAS BEEN SUSPENDED. KICKOFF HAS BEEN DELAYED DUE TO WEATHER.			
THE GAME HAS BEEN SUSPENDED. THE GAME HAS BEEN SUSPENDED DUE TO WEATHER.			
THE GAME HAS RESUMED.

```{r}
# standings <- read_csv("http://www.habitatring.com/standings.csv")
# plays <- plays %>%
#   inner_join(standings,by=c("season"="season","posteam"="team"))
```

```{r}
library(nflfastR)

# ids <- fast_scraper_schedules(2017:2019) %>%
#   filter(game_type == "SB") %>%
#   pull(game_id)
# pbp <- build_nflfastR_pbp(ids)
```

```{r}
loadedpbp <- load_pbp(2018:2020, qs = TRUE)
```


```{r}
names(loadedpbp)
```

```{r}
sch2015 <- fast_scraper_schedules(2015)
sch2016 <- fast_scraper_schedules(2016)
sch2017 <- fast_scraper_schedules(2017)
sch2018 <- fast_scraper_schedules(2018)
sch2019 <- fast_scraper_schedules(2019)
sch2020 <- fast_scraper_schedules(2020)
```

```{r}
sch2015 %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  group_by(home_team) %>%
  mutate(totalhomewins = sum(homewin)) %>%
  ungroup() %>%
  group_by(away_team) %>%
  mutate(totalawaywin = sum(viswin))
```

```{r}
sch2015 %>%
  filter(away_team == 'BAL'|home_team == 'BAL') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  group_by(away_team) %>%
  mutate(teamawaywins = sum(viswin)) %>%
  ungroup() %>%
  group_by(home_team) %>%
  mutate(teamhomewins = sum(homewin)) %>%
  ungroup() %>%
  select(home_team, away_team, homewin, viswin, gmtie, teamawaywins, teamhomewins)
```

```{r 15 hometeam wins}
sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  filter(homewin == 1) %>%
  group_by(home_team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r 15 away team wins}
sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  filter(viswin == 1) %>%
  group_by(away_team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r 15 ties}
sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  filter(gmtie == 1) %>%
  group_by(home_team) %>%
  summarise(tie = sum(gmtie))

sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0)) %>%
  filter(gmtie == 1) %>%
  group_by(away_team) %>%
  summarise(tie = sum(gmtie))
```

```{r homewins15 creation}
homewins15 <- sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins15 creation}
viswins15 <- sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties15 creation}
hometies15 <- sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties15 <- sch2015 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties15 <- hometies15 %>%
  rbind(visties15)
```

```{r teamstandings15 creation}
teamstandings15 <- homewins15 %>%
  left_join(viswins15) %>%
  left_join(ties15) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```

```{r homewins16 creation}
homewins16 <- sch2016 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins16 creation}
viswins16 <- sch2016 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties16 creation}
hometies16 <- sch2016 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties16 <- sch2016 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties16 <- hometies16 %>%
  rbind(visties16)
```

```{r teamstandings16 creation}
teamstandings16 <- homewins16 %>%
  left_join(viswins16) %>%
  left_join(ties16) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```


```{r homewins17 creation}
homewins17 <- sch2017 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins17 creation}
viswins17 <- sch2017 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties17 creation}
hometies17 <- sch2017 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties17 <- sch2017 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties17 <- hometies17 %>%
  rbind(visties17)
```

```{r teamstandings17 creation}
CLE <- data.frame(team = 'CLE', wins = 0, loss = 16, tie = 0)

teamstandings17 <- homewins17 %>%
  left_join(viswins17) %>%
  left_join(ties17) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)

teamstandings17 <- teamstandings17 %>%
  rbind(CLE)
```


```{r homewins18 creation}
homewins18 <- sch2018 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins18 creation}
viswins18 <- sch2018 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties18 creation}
hometies18 <- sch2018 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties18 <- sch2018 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties18 <- hometies18 %>%
  rbind(visties18)
```

```{r teamstandings18 creation}
teamstandings18 <- homewins18 %>%
  left_join(viswins18) %>%
  left_join(ties18) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```

```{r homewins19 creation}
homewins19 <- sch2019 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins19 creation}
viswins19 <- sch2019 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties19 creation}
hometies19 <- sch2019 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties19 <- sch2019 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties19 <- hometies19 %>%
  rbind(visties19)
```

```{r teamstandings19 creation}
teamstandings19 <- homewins19 %>%
  left_join(viswins19) %>%
  left_join(ties19) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```

```{r homewins20 creation}
homewins20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins20 creation}
viswins20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties20 creation}
hometies20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties20 <- hometies20 %>%
  rbind(visties20)
```

```{r teamstandings20 creation}
teamstandings20 <- homewins20 %>%
  left_join(viswins20) %>%
  left_join(ties20) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```






