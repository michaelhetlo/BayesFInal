---
title: "Model Code"
output: html_document
---

```{r setup, warning=FALSE, message=FALSE,echo=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r,message=FALSE, warning=FALSE,echo=TRUE}
# Load packages
library(bayesrules)
library(tidyverse)
library(rstanarm)
library(broom.mixed)
library(tidybayes)
library(forcats)
library(bayesplot)
library(lubridate)
library(nflfastR)
library(naniar)
```


## Data Introduction

Our data comes Nflfastr. It is an R package that has scraped data into R to make it easier to create NFL analytics. The data includes play-by-play data from 1999 until the present. The package designer of is Maksim Horwitz. They use an API to directly scrape data from the NFL. This data was specifically collected to perform advanced analytics in the NFL. The NFL was and still is behind the other three major sports leagues in data sharing and analytics. 




# https://developer.nfl.com/get-started/overview

# https://www.kaggle.com/maxhorowitz/nflplaybyplay2009to2016

```{r,warning=FALSE}
data1 <- load_pbp(2019)
```



```{r}
dim(data1)
```



```{r}
head(data1)
```




https://www.nflfastr.com/articles/field_descriptions.html





```{r, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  comment = "#>"
)

with_dt <- requireNamespace("DT")

```

```{r eval = with_dt}
# DT::datatable(nflfastR::field_descriptions,options = list(scrollX = TRUE, pageLength = 372), filter = "top", rownames = FALSE)
```

```{r eval = with_dt}
# knitr::kable(nflfastR::field_descriptions)
```

```{r sch2020 creation}
sch2020 <- fast_scraper_schedules(2020)
```


```{r homewins20 creation}
homewins20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(homewin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.home = sum(homewin))
```

```{r viswins20 creation}
viswins20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(viswin == 1) %>%
  group_by(team) %>%
  summarise(wins.at.away = sum(viswin))
```

```{r ties20 creation}
hometies20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = home_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

visties20 <- sch2020 %>%
  filter(game_type == 'REG') %>%
  mutate(homewin = ifelse(home_result > 0, 1, 0),
         viswin = ifelse(home_result < 0, 1, 0),
         gmtie = ifelse(home_result == 0, 1, 0),
         team = away_team) %>%
  filter(gmtie == 1) %>%
  group_by(team) %>%
  summarise(tie = sum(gmtie))

ties20 <- hometies20 %>%
  rbind(visties20)
```

```{r teamstandings20 creation}
teamstandings20 <- homewins20 %>%
  left_join(viswins20) %>%
  left_join(ties20) %>%
  mutate(tie = ifelse(is.na(tie) == TRUE, 0, tie),
         wins.at.home = ifelse(is.na(wins.at.home) == TRUE, 0, wins.at.home),
         wins.at.away = ifelse(is.na(wins.at.away) == TRUE, 0, wins.at.away),
         wins = wins.at.away + wins.at.home,
         loss = 16 - (wins + tie)) %>%
  select(team, wins, loss, tie)
```



## Data Cleaning and Exploration

Below we have the the amount of wins for each team in the 2020 season, using this prior knowledgue of team quality will help to inform us of future game win probability. 

```{r,echo=TRUE}
data_new <- load_pbp(2020)
```


```{r,echo=TRUE}
halftime_score_diff_2020 <- data_new %>%
  filter(half_seconds_remaining == 0 & game_half == "Half1" & season_type == "REG")%>%
  mutate(score_differential = total_home_score - total_away_score)%>%
  select(game_id, home_team, away_team, game_half, score_differential)
```


```{r,echo=TRUE}
end_score_diff_2020 <- data_new %>%
  filter(half_seconds_remaining == 0 & game_half == "Half2" & season_type == "REG")%>%
  mutate(score_differential = total_home_score- total_away_score)%>%
  select(game_id, home_team, away_team, score_differential,spread_line) %>%
  mutate(home_team_win = if_else(score_differential > 0, 1, 0))

score_diff_data <- halftime_score_diff_2020 %>%
  inner_join(end_score_diff_2020, by = "game_id")

first_q_diff <- data_new %>%
  filter(quarter_end == 1 & qtr == 1 & season_type == "REG") %>%
  mutate(score_differential = total_home_score- total_away_score)%>%
  select(game_id, home_team, away_team, score_differential, spread_line)

second_q_diff <- data_new %>%
  filter(quarter_end == 1 & qtr == 2 & season_type == "REG") %>%
  mutate(score_differential = total_home_score- total_away_score)%>%
  select(game_id, home_team, away_team, score_differential) 

third_q_diff <- data_new %>%
  filter(quarter_end == 1 & qtr == 3 & season_type == "REG") %>%
  mutate(score_differential = total_home_score- total_away_score)%>%
  select(game_id, home_team, away_team, score_differential)

fourth_q_diff <- data_new %>%
  filter(quarter_end == 1 & qtr == 4 & season_type == "REG") %>%
  mutate(score_differential = total_home_score- total_away_score)%>%
  select(game_id, home_team, away_team, score_differential) %>%
  mutate(home_team_win = if_else(score_differential > 0, 1, 0))

quarter_score_diff <- first_q_diff %>%
  inner_join(second_q_diff, by = "game_id") %>%
   inner_join(third_q_diff, by = "game_id") %>%
   inner_join(end_score_diff_2020, by = "game_id") 


```

```{r,echo=TRUE}
teamstandings20 <- teamstandings20 %>%
  left_join(teams_colors_logos, by = c("team" = "team_abbr"))
  

ggplot(teamstandings20) + 
  aes(x = team, y = wins) + 
  geom_col(fill = teamstandings20$team_color) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r}
score_diff_data %>%
  ggplot() + 
  aes(x = score_differential.y) + 
  geom_histogram(binwidth = 7)
```

This graph above shows us that there is quite a lot of parity in the league making every score in our model matter a lot. 


```{r}
data_new %>%
  filter(game_id == "2020_01_ARI_SF") %>%
  ggplot() + 
  aes(x = game_seconds_remaining, y = total_home_epa ) + 
  geom_line()
```

This graph shows us the epa or expected points added by each play throughout a game. This gives us insight into how the home team did throughout the game which will help us predict each teams win probability thorughout the game. 

```{r}
data_new %>%
  filter(game_id == "2020_01_ARI_SF") %>%
  ggplot() + 
  aes(x = game_seconds_remaining, y = home_wp) + 
  geom_line()
```

This is a win probability graph. This is ultimately what we would like to build up to and create, this was made by NFLFastR, and is something that we hope to be able to create ultimately. 



## Basic Model

Our first model is a basic logistic regression model that predicts who will win the game based on the end of first quarter score. 
```{r}
week_1 <- stan_glm(
  home_team_win~ score_differential.x,
  data = score_diff_data,
  family = binomial,
  chains = 4, iter = 5000*2, seed = 84735, refresh = 0
)

week_1
```

```{r}

pp_check(week_1)
```


## Final Models

Our next steps are to finish creating our prior analysis on how good each team is and then we will complicate our model more and we may try to create a shiny app to make our model more interactive so that people can enter certain teams and game situations to predict the win probability for a certain team. 



# Model 0 
### This model uses the Vegas Spreadline when prior to the beginning of the game


```{r,echo=TRUE}
log_model_0 <- stan_glm(home_team_win ~ spread_line.x, 
                                      data = quarter_score_diff, 
                                      family = binomial,
  chains = 4, iter = 5000*2, seed = 84735, refresh = 0)
```





```{r,echo=TRUE}
saveRDS(log_model_0,"pregame_model.rds")

```



```{r,echo=TRUE}
classification_summary(log_model_0,quarter_score_diff)
```

```{r}
mod_0<-tidy(log_model_0)
mod_0
exp(mod_0$estimate)
```


# Model 1
### This model uses the Vegas spreadline and the score differential after the 1st quarter.

```{r,echo=TRUE}
log_model_1 <- stan_glm(home_team_win ~ score_differential.x + spread_line.x, 
                                      data = quarter_score_diff, 
                                      family = binomial,
  chains = 4, iter = 5000*2, seed = 84735, refresh = 0)
```

```{r,echo=TRUE}
classification_summary(log_model_1, quarter_score_diff)
```



```{r,echo=TRUE}
classification_summary(log_model_1, quarter_score_diff)
```

```{r,echo=TRUE}
mod1<- tidy(log_model_1,conf.int = TRUE,conf.level = .95)
mod1
```
```{r,echo=TRUE}
exp(mod1$estimate)
```

```{r,echo=TRUE}
saveRDS(log_model_1,"first_quarter.rds")
```


# Model 2 
### This model uses the Vegas Spreadline and the halftime score differential.

```{r,echo=TRUE}
log_model_2 <- stan_glm(home_team_win ~  
                                       score_differential.y+ 
                                      spread_line.x, 
                                      data = quarter_score_diff, 
                                      family = binomial,
  chains = 4, iter = 5000*2, seed = 84735, refresh = 0)
```


```{r, eval=FALSE}
pp_check(log_model_2)
```


```{r,echo=TRUE}
classification_summary(log_model_2, quarter_score_diff)
```





```{r,echo=TRUE}
mod_2 <- tidy(log_model_2, conf.int = TRUE, conf.level = .95)
mod_2
```

```{r,echo=TRUE}
exp(mod_2$estimate)
```



```{r,echo=TRUE}
saveRDS(log_model_2, "second_quarter.rds")
```


# Model 3
### This model uses Vegas Spreadline and Score Differential after the 3rd Quarter.

```{r,echo=TRUE}
log_model_3 <- stan_glm(home_team_win ~ score_differential.x.x + spread_line.x, 
                                      data = quarter_score_diff, 
                                      family = binomial,
  chains = 4, iter = 5000*2, seed = 84735, refresh = 0)
```



```{r,echo=TRUE}
classification_summary(log_model_3,quarter_score_diff,cutoff = .5)
```

```{r,echo=TRUE}
model_sum <- tidy(log_model_3, conf.int = TRUE, conf.level = .95)
model_sum
```

```{r,echo=TRUE}
exp(model_sum$estimate)
```


```{r,echo=TRUE}
saveRDS(log_model_3, "third_quarter.rds")
```





 
 
 
 
 
 
 

